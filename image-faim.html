<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IB French B ‚Äì Bingo d‚Äôexpression orale (Image RFI)</title>
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --brand:#22d3ee; --accent:#34d399; --shadow:0 10px 30px rgba(0,0,0,.35);
      --free-bg:linear-gradient(180deg, rgba(52,211,153,.35), rgba(34,211,238,.45));
      --free-color:#22d3ee; --good:#34d399; --warn:#fbbf24; --bad:#ef4444;
    }
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans"; color:var(--text); background:radial-gradient(1200px 600px at 15% 0%, #1f2937 0%, var(--bg) 60%)}
    .wrap{max-width:1200px; margin:0 auto; padding:24px 18px 88px}
    header{display:grid; grid-template-columns:1fr; gap:16px; align-items:center; margin-bottom:18px}
    @media(min-width:900px){header{grid-template-columns:1.3fr .9fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:var(--shadow)}
    .imgCard{position:relative; overflow:hidden}
    .imgCard img{display:block; width:100%; height:100%; object-fit:cover; border-radius:16px}
    .imgInfo{position:absolute; inset:auto 12px 12px 12px; background:rgba(0,0,0,.45); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px 12px; font-size:.9rem}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); color:var(--text); background:linear-gradient(180deg, rgba(34,211,238,.1), rgba(167,139,250,.06)); cursor:pointer; transition:.15s transform ease, .2s filter ease; user-select:none}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform:translateY(1px)}
    .grid{margin-top:16px; display:grid; grid-template-columns:repeat(5,1fr); gap:10px}
    .cell{min-height:130px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:12px; position:relative; overflow:hidden; cursor:pointer; transition:.15s transform ease, .25s box-shadow ease}
    .cell:hover{box-shadow:0 10px 25px rgba(34,211,238,.15); transform:translateY(-2px)}
    .cell h4{margin:0 0 6px; font-size:.95rem; color:var(--brand)}
    .cell.free{background:var(--free-bg)}
    .cell.free h4{color:var(--free-color); text-shadow:0 0 6px rgba(34,211,238,.85)}
    .cell p{margin:0; font-size:.92rem; color:var(--text)}
    .badge{position:absolute; top:8px; right:8px; font-size:.75rem; background:rgba(52,211,153,.2); color:#d1fae5; border:1px solid rgba(52,211,153,.35); padding:4px 8px; border-radius:999px; display:none}
    .cell.completed .badge{display:inline-block}
    .assist{margin-top:6px; font-size:.8rem; color:var(--muted)}
    .tabHeader{display:flex; justify-content:center; gap:8px; margin-bottom:16px}
    .tabBtn{padding:10px 20px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(34,211,238,.1); color:var(--text); cursor:pointer}
    .tabBtn.active{background:var(--brand); color:#000}
    .tabContent{display:none}
    .tabContent.active{display:block}
    .chunkBank{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px; background:rgba(255,255,255,.05); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,.1)}
    .chunk{background:rgba(34,211,238,.1); border:1px solid rgba(34,211,238,.2); border-radius:10px; padding:8px; font-size:.9rem; text-align:center}
    .toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0b1526; border:1px solid rgba(255,255,255,.12); color:var(--text); padding:10px 14px; border-radius:10px; display:none}

    /* Progress tracker */
    .progress{display:flex; align-items:center; gap:12px; margin-top:10px}
    .mini{display:grid; grid-template-columns:repeat(5,10px); gap:4px; padding:6px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:rgba(255,255,255,.03)}
    .mini div{width:10px;height:10px;border-radius:2px;background:#374151}
    .mini div.done{background:var(--good)}
    .bingoTag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background:rgba(52,211,153,.15); color:#d1fae5}

    /* Modal */
    dialog{border:none; border-radius:16px; padding:0; background:transparent}
    .modal{width:min(780px,94vw); background:linear-gradient(180deg,#0b1220,#0a0f1a); border:1px solid rgba(255,255,255,.1); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .modal header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .modal header h3{margin:0; font-size:1.05rem}
    .modal .body{display:grid; grid-template-columns:1fr; gap:12px; padding:14px 16px}
    .modal .prompt{font-size:.98rem; color:#e2e8f0}
    .kbdRow{display:flex; flex-wrap:wrap; gap:8px; padding:10px; border:1px dashed rgba(255,255,255,.15); border-radius:12px; background:rgba(255,255,255,.03)}
    .kbdRow button{padding:6px 10px; border-radius:8px; background:#0b1526; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); cursor:pointer}
    textarea{width:100%; min-height:140px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1526; color:var(--text); resize:vertical}
    .modal footer{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:14px 16px; border-top:1px solid rgba(255,255,255,.08)}
    .hint{font-size:.85rem; color:var(--muted)}

    /* Audio controls */
    .audioBar{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .audioBar .rec{background:linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08)); border-color:rgba(239,68,68,.35)}
    .audioBar .timer{font-variant-numeric:tabular-nums; min-width:54px; text-align:center}
    .permWarn{display:none;color:#fecaca;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);padding:8px 10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="tabHeader">
      <button class="tabBtn active" data-tab="bingo" type="button">üéØ Bingo</button>
      <button class="tabBtn" data-tab="chunks" type="button">üí¨ Banque de chunks utiles</button>
    </div>

    <div id="bingo" class="tabContent active">
      <header>
        <section class="card imgCard">
          <img src="https://s.rfi.fr/media/display/031a1820-6045-11ef-ae83-005056bf30b7/w:1280/p:1x1/000_TA836.jpg" alt="Image d‚Äôactualit√© : situation de crise alimentaire ou humanitaire (contexte exact non pr√©cis√©)" />
          <div class="imgInfo"><strong>D√©clencheur visuel</strong> ‚Äî Observe l‚Äôimage 30 s. <em>N‚Äôinterpr√®te pas trop vite</em> : propose d‚Äôabord des hypoth√®ses et cite les indices visuels.</div>
        </section>
        <section class="card" style="padding:14px 16px">
          <h2 style="margin:8px 0 12px; letter-spacing:.3px">Bingo d‚Äôexpression orale ‚Äì IB French B (SL)</h2>
          <p class="small" style="margin-top:0">Th√®mes : Organisation sociale ‚Ä¢ Partage de la plan√®te ‚Ä¢ Justice sociale. Clique une case, r√©dige ta r√©flexion, puis √©change avec un camarade.</p>
          <div class="controls">
            <button class="btn" id="shuffleBtn" type="button">üîÄ M√©langer</button>
            <button class="btn" id="clearBtn" type="button">üßπ Effacer</button>
            <button class="btn" id="exportBtn" type="button">‚¨áÔ∏è Exporter</button>
            <div class="progress" id="progress">
              <div class="mini" id="mini"></div>
              <span id="countText">0/25</span>
              <span class="bingoTag" id="bingoTag" style="display:none">üéâ BINGO !</span>
            </div>
          </div>
        </section>
      </header>

      <section class="grid" id="grid"></section>
    </div>

    <div id="chunks" class="tabContent">
      <h2>üí¨ Banque de chunks utiles</h2>
      <p class="small">Filtre par cat√©gorie et recherche. Clique pour ins√©rer (si une case est ouverte) ou pour copier.</p>
      <div class="card" style="padding:12px; margin-bottom:10px">
        <div id="chunkFilters" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center">
          <strong style="margin-right:6px">Cat√©gories¬†:</strong>
          <button class="btn" data-cat="all" type="button">Toutes</button>
          <button class="btn" data-cat="amorces" type="button">Amorces</button>
          <button class="btn" data-cat="verbes" type="button">Verbes</button>
          <button class="btn" data-cat="descriptions" type="button">Descriptions</button>
          <button class="btn" data-cat="connecteurs" type="button">Connecteurs</button>
          <button class="btn" data-cat="nuancer" type="button">Nuancer</button>
          <button class="btn" data-cat="interaction" type="button">Interaction</button>
          <button class="btn" data-cat="donnees" type="button">Donn√©es</button>
          <button class="btn" data-cat="hypotheses" type="button">Hypoth√®ses</button>
          <input id="chunkSearch" type="search" placeholder="Rechercher‚Ä¶" style="margin-left:auto; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1526; color:var(--text); min-width:200px" />
        </div>
      </div>
      <div class="chunkBank" id="chunkBank"></div>
    </div>
  </div>

  <dialog id="dlg">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h3 id="dlgTitle">R√©ponds √† la t√¢che</h3>
        <button class="btn" id="closeDlg" type="button">‚úñ</button>
      </header>
      <div class="body">
        <div class="prompt" id="dlgPrompt"></div>
        <label for="resp" class="hint">Ta r√©ponse (tu peux parler d‚Äôabord, puis √©crire un bref r√©sum√©) :</label>
        <textarea id="resp" placeholder="√âcris ici‚Ä¶"></textarea>
        <div>
          <div class="hint" style="margin-bottom:6px"><strong>Clavier d‚Äôaccents</strong> : clique pour ins√©rer dans le texte</div>
          <div class="kbdRow" id="kbd"></div>
        </div>
        <div class="audioBar">
          <button class="btn rec" id="recBtn" type="button">‚è∫Ô∏è Enregistrer</button>
          <button class="btn" id="stopBtn" type="button" disabled>‚èπÔ∏è Stop</button>
          <button class="btn" id="playBtn" type="button" disabled>‚ñ∂Ô∏è √âcouter</button>
          <button class="btn" id="delAudioBtn" type="button" disabled>üóëÔ∏è Supprimer audio</button>
          <button class="btn" id="uploadBtn" type="button">üì§ Importer audio</button>
          <input id="uploadInput" type="file" accept="audio/*" style="display:none" />
          <span class="hint timer" id="timer">00:00</span>
          <audio id="audio" controls style="display:none; width:100%"></audio>
        </div>
        <div id="permWarn" class="permWarn">Micro non accessible. V√©rifie les permissions du navigateur et les param√®tres de l‚Äôiframe (autoriser le microphone).</div>
      </div>
      <footer>
        <span class="hint" id="count">0/800 caract√®res</span>
        <div style="display:flex; gap:8px">
          <button class="btn" id="save" type="button">üíæ Enregistrer</button>
          <button class="btn" id="clearCell" type="button">Effacer la r√©ponse</button>
        </div>
      </footer>
    </div>
  </dialog>

  <div class="toast" id="toast">Action effectu√©e</div>

  <script>
    // ---------- Utilities ----------
    const toast = document.getElementById('toast');
    function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 1300); }

    // Clipboard helper (safe in blocked/sandboxed contexts)
    function copyMaybe(text){
      try{
        if(!('clipboard' in navigator) || !navigator.isSecureContext){ return false; }
        const p = navigator.clipboard.writeText(text);
        if(p && typeof p.then==='function') p.catch(()=>{});
        return true;
      }catch(e){ return false; }
    }

    // ---------- Accent keyboard ----------
    const ACCENTS = ['√†','√¢','√§','√¶','√ß','√©','√®','√™','√´','√Æ','√Ø','√¥','≈ì','√∂','√π','√ª','√º','√ø','√Ä','√á','√â','√à','√ä','√ã','√é','√è','√î','√ô','√õ','√ú','¬´','¬ª','‚Ç¨'];

    // ---------- Chunk bank ----------
    const CHUNKS = [
      {cat:'amorces', text:"√Ä mon avis, ‚Ä¶"}, {cat:'amorces', text:"Selon moi, ‚Ä¶"}, {cat:'amorces', text:"Il me semble que ‚Ä¶"},
      {cat:'amorces', text:"D‚Äôapr√®s l‚Äôimage, on peut supposer que ‚Ä¶"}, {cat:'amorces', text:"On dirait que ‚Ä¶"}, {cat:'amorces', text:"Je ne suis pas certain(e), mais ‚Ä¶"},
      {cat:'verbes', text:"sugg√©rer / indiquer / r√©v√©ler"}, {cat:'verbes', text:"mettre en valeur / souligner / accentuer"}, {cat:'verbes', text:"impliquer / entra√Æner / provoquer"},
      {cat:'verbes', text:"faudrait (il faudrait‚Ä¶) / pourrait (on pourrait‚Ä¶)"}, {cat:'verbes', text:"exiger / n√©cessiter (il est n√©cessaire de‚Ä¶)"},
      {cat:'descriptions', text:"premier plan / arri√®re-plan / cadrage"}, {cat:'descriptions', text:"lumi√®re / ombre / contraste"}, {cat:'descriptions', text:"expressions du visage / posture"},
      {cat:'descriptions', text:"paysage aride / s√©cheresse / poussi√®re"}, {cat:'descriptions', text:"objets visibles (sacs, eau, camions d‚Äôaide)"},
      {cat:'connecteurs', text:"d‚Äôabord / ensuite / enfin"}, {cat:'connecteurs', text:"cependant / pourtant / en revanche"}, {cat:'connecteurs', text:"donc / ainsi / par cons√©quent"},
      {cat:'connecteurs', text:"non seulement ‚Ä¶ mais aussi ‚Ä¶"},
      {cat:'nuancer', text:"Je comprends ton point de vue, mais ‚Ä¶"}, {cat:'nuancer', text:"Je ne suis pas enti√®rement d‚Äôaccord, car ‚Ä¶"}, {cat:'nuancer', text:"Tu as raison sur ‚Ä¶, cependant ‚Ä¶"},
      {cat:'interaction', text:"Et toi, qu‚Äôen penses‚Äëtu ?"}, {cat:'interaction', text:"Peux‚Äëtu donner un exemple concret ?"}, {cat:'interaction', text:"Et si on envisageait l‚Äôangle de ‚Ä¶ ?"},
      {cat:'donnees', text:"Selon les donn√©es / le rapport, ‚Ä¶"}, {cat:'donnees', text:"Une augmentation / une baisse de ‚Ä¶ %"}, {cat:'donnees', text:"√† court terme / √† long terme"},
      {cat:'hypotheses', text:"Si + imparfait, ‚Ä¶ conditionnel (Si on investissait‚Ä¶, on r√©duirait‚Ä¶)"}, {cat:'hypotheses', text:"Dans le cas o√π ‚Ä¶, on pourrait ‚Ä¶"}, {cat:'hypotheses', text:"√Ä confirmer avec d‚Äôautres sources."}
    ];

    const chunkBank = document.getElementById('chunkBank');
    const chunkFilters = document.getElementById('chunkFilters');
    const chunkSearch = document.getElementById('chunkSearch');

    let activeCat = 'all';

    function renderChunks(){
      const q = (chunkSearch && chunkSearch.value ? chunkSearch.value : '').toLowerCase().trim();
      chunkBank.innerHTML = '';
      CHUNKS.filter(c => (activeCat==='all' || c.cat===activeCat))
            .filter(c => !q || (c.text.toLowerCase().includes(q)))
            .forEach(c => {
              const div = document.createElement('div');
              div.className = 'chunk';
              div.textContent = c.text;
              div.title = c.cat;
              div.addEventListener('click',()=>{
                if(dlg.open){ insertAtCursor(resp, (resp.value && !resp.value.endsWith('\n') ? ' ' : '') + c.text + ' '); }
                else { const ok = copyMaybe(c.text); showToast(ok?'Copi√© ‚úîÔ∏é':'Copie bloqu√©e ‚Äî ouvre une case pour ins√©rer'); }
              });
              chunkBank.appendChild(div);
            });
    }

    if(chunkFilters){
      chunkFilters.addEventListener('click',(e)=>{
        const btn = e.target.closest('button[data-cat]');
        if(!btn) return;
        activeCat = btn.getAttribute('data-cat');
        [...chunkFilters.querySelectorAll('button[data-cat]')].forEach(b=>{ if(b===btn) b.classList.add('active'); else b.classList.remove('active'); });
        renderChunks();
      });
      const allBtn = chunkFilters.querySelector('button[data-cat="all"]'); if(allBtn) allBtn.classList.add('active');
    }
    if(chunkSearch){ chunkSearch.addEventListener('input', renderChunks); }

    renderChunks();

    // ---------- Tabs ----------
    const tabs=document.querySelectorAll('.tabBtn');
    const contents=document.querySelectorAll('.tabContent');
    tabs.forEach(btn=>btn.addEventListener('click',()=>{tabs.forEach(b=>b.classList.remove('active'));contents.forEach(c=>c.classList.remove('active'));btn.classList.add('active');document.getElementById(btn.dataset.tab).classList.add('active');}));

    // ---------- Prompts (>= 24, each with valid .t) ----------
    const PROMPTS=[
      {t:'D√©cris la sc√®ne de fa√ßon neutre : qui, quoi, o√π ? Quels indices visuels ?'},
      {t:'Formule deux hypoth√®ses oppos√©es (ex : famine ? s√©cheresse ? autre ?) et justifie.'},
      {t:'Quels <strong>indices</strong> soutiennent ton hypoth√®se ? Lesquels la contredisent ?'},
      {t:'Exprime ton ressenti avec nuance : ¬´ je me sens‚Ä¶ ¬ª, ¬´ cela √©voque‚Ä¶ ¬ª'},
      {t:'Relie cette image au th√®me <em>Organisation sociale</em> (aide, sant√©, logement).'},
      {t:'Relie cette image au th√®me <em>Partage de la plan√®te</em> (ressources, climat, humanit√©).'},
      {t:'Exprime une opinion nuanc√©e : ¬´ Je comprends que‚Ä¶, mais‚Ä¶ ¬ª'},
      {t:'R√©dige une <em>question ouverte</em> pour une organisation humanitaire ou locale.'},
      {t:'Propose un <em>titre</em> pour la photo et explique ton choix sans pr√©sumer.'},
      {t:'Compare avec une autre crise humanitaire ou environnementale.'},
      {t:'Donne deux <strong>actions r√©alistes</strong> √† court et long terme.'},
      {t:'Analyse lumi√®re/cadrage : quel effet sur la perception du sujet ?'},
      {t:'Quels <strong>droits humains</strong> pourraient √™tre concern√©s ?'},
      {t:'Rep√®re un <em>st√©r√©otype possible</em> et reformule pour pr√©server la dignit√©.'},
      {t:'Subjonctif : ¬´ Il faut que‚Ä¶ ¬ª / ¬´ Bien que‚Ä¶ ¬ª ‚Üí propose une piste d‚Äôaction.'},
      {t:'Fais une <em>auto-critique</em> : que ne peut-on pas d√©duire de cette image ?'},
      {t:'Liste 3 informations qu‚Äôil faudrait v√©rifier avec des sources fiables.'},
      {t:'Relie cette image √† une ≈ìuvre litt√©raire ou artistique pertinente.'},
      {t:'√âchange : pose une question de relance (¬´ et si‚Ä¶ ? ¬ª).'},
      {t:'Conclue par une phrase d‚Äôespoir ou de solution concr√®te.'},
      {t:'D√©cris le contexte possible (temps/m√©t√©o/lieu) uniquement √† partir d‚Äôindices.'},
      {t:'Transforme une affirmation en question prudente (passer de ¬´ c‚Äôest ¬ª √† ¬´ serait-ce‚Ä¶ ? ¬ª).'},
      {t:'Propose un indicateur pour √©valuer l‚Äôimpact d‚Äôune action.'},
      {t:'Reformule l‚Äôid√©e d‚Äôun camarade avec nuance (accord partiel + concession).'},
      {t:'Relie l‚Äôimage √† un Objectif de D√©veloppement Durable pertinent (justifie).'},
      {t:'Explique un mot-cl√© (ex. ¬´ ins√©curit√© alimentaire ¬ª) et utilise-le dans une phrase.'}
    ];

    // ---------- Helpers ----------
    function shuffle(arr){return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1])}
    function getPromptPool(){
      const valid = PROMPTS.filter(p=>p && typeof p.t==='string' && p.t.trim().length>0);
      const needed = 24 - valid.length;
      const fillers = [];
      for(let i=1;i<=Math.max(0,needed);i++) fillers.push({t:`T√¢che suppl√©mentaire ${i} : d√©cris un indice visuel et son interpr√©tation possible.`});
      return shuffle([...valid, ...fillers]).slice(0,24);
    }

    // ---------- Lines for bingo ----------
    const LINES = (()=>{
      const rows=[0,5,10,15,20].map(s=>[s,s+1,s+2,s+3,s+4]);
      const cols=[0,1,2,3,4].map(c=>[c,c+5,c+10,c+15,c+20]);
      const diags=[[0,6,12,18,24],[4,8,12,16,20]]; return [...rows,...cols,...diags];
    })();

    // ---------- State & storage ----------
    // Ephemeral mode: do not persist across reloads or tabs.
    // Set `?persist=1` in the URL to disable ephemeral mode and use localStorage again.
    const LS_KEY='ibfb-rfi-v3';
    const EPHEMERAL = (new URLSearchParams(location.search).get('persist') !== '1');
    let board=[]; // array of 25 {id,prompt,response,completed,free,audio?:{dataUrl,mime}}

    // If we switch to ephemeral, proactively clear any previous persisted state on this origin
    if(EPHEMERAL){ try{ localStorage.removeItem(LS_KEY); }catch(e){} }

    function save(){
      if(EPHEMERAL) return; // no-op in ephemeral mode
      try{ localStorage.setItem(LS_KEY, JSON.stringify(board)); }catch(e){}
    }
    function load(){
      if(!EPHEMERAL){
        try{ const raw=localStorage.getItem(LS_KEY); if(raw){ board=JSON.parse(raw); render(); updateProgress(); return; } }catch(e){}
      }
      buildBoard();
    }

    // ---------- Build & render board ----------
    const gridEl=document.getElementById('grid');
    const mini=document.getElementById('mini');
    const countText=document.getElementById('countText');
    const bingoTag=document.getElementById('bingoTag');

    function buildBoard(){
      const pool = getPromptPool(); let k=0; const cells=[];
      for(let i=0;i<25;i++){
        if(i===12){ cells.push({id:'c12', prompt:'Propose ton propre angle d‚Äôanalyse.', response:'', completed:true, free:true}); }
        else{ const p=pool[k++]; cells.push({id:'c'+i, prompt:p.t, response:'', completed:false, free:false}); }
      }
      board=cells; save(); render(); updateProgress();
    }

    function render(){
      gridEl.innerHTML='';
      board.forEach((cell,idx)=>{
        const el=document.createElement('button');
        el.type='button'; el.className='cell'+(cell.free?' free':'')+(cell.completed?' completed':'');
        el.setAttribute('data-id', cell.id);
        el.innerHTML = (cell.free?'<h4>CARTE LIBRE</h4>':'<h4>T√ÇCHE</h4>') + `<p>${cell.prompt}</p>` + `<span class="badge">Fait</span>` + (cell.response?`<div class="assist">R√©ponse sauvegard√©e ‚úì</div>`:'') + (cell.audio?`<div class="assist">üéôÔ∏è Audio enregistr√©</div>`:'');
        el.addEventListener('click',(e)=>{ if(!e.isTrusted) return; __userGesture = true; try{ openCell(cell.id); } finally { __userGesture = false; } });
        gridEl.appendChild(el);
      });
    }

    // ---------- Progress tracker ----------
    function updateProgress(){
      mini.innerHTML='';
      board.forEach((c)=>{ const d=document.createElement('div'); d.className=''; if(c.completed) d.classList.add('done'); mini.appendChild(d); });
      const completed=board.filter(c=>c.completed).length; countText.textContent = completed+'/25';
      const bingoLines = LINES.filter(line=>line.every(i=>board[i].completed));
      bingoTag.style.display = bingoLines.length>0 ? 'inline-flex' : 'none';
      if(bingoLines.length>0) showToast('üéâ BINGO !');
    }

    // ---------- Modal & keyboard ----------
    // Guard against non‚Äëuser‚Äëinitiated opens (Schoology/Chrome sometimes fires synthetic clicks).
    // We use two gates: (1) event.isTrusted on the click handler, (2) a global "user interacted" latch.
    let __userGesture = false;
    let __userInteracted = false;
    ['pointerdown','keydown','touchstart'].forEach(t=>window.addEventListener(t,()=>{__userInteracted=true},{once:true,passive:true}));
    const dlg=document.getElementById('dlg');
    const dlgPrompt=document.getElementById('dlgPrompt');
    const resp=document.getElementById('resp');
    const closeDlg=document.getElementById('closeDlg');
    const saveBtn=document.getElementById('save');
    const clearCellBtn=document.getElementById('clearCell');
    const count=document.getElementById('count');
    const kbd=document.getElementById('kbd');
    const permWarn=document.getElementById('permWarn');
    let currentId=null;

    function openCell(id){
      // Only open when called from a real user gesture AND after first human interaction
      if(!__userGesture || !__userInteracted) { return; }
      currentId=id; const cell=board.find(c=>c.id===id);
      dlgPrompt.innerHTML=(cell.free?'<strong>CARTE LIBRE</strong> ‚Äì ':'<strong>T√ÇCHE</strong> ‚Äì ')+cell.prompt;
      resp.value=cell.response||''; updateCount(); if(!dlg.open) dlg.showModal(); setTimeout(()=>resp.focus(),40);
      loadAudioUI(cell);
      preflightMic();
    }
      currentId=id; const cell=board.find(c=>c.id===id);
      dlgPrompt.innerHTML=(cell.free?'<strong>CARTE LIBRE</strong> ‚Äì ':'<strong>T√ÇCHE</strong> ‚Äì ')+cell.prompt;
      resp.value=cell.response||''; updateCount(); if(!dlg.open) dlg.showModal(); setTimeout(()=>resp.focus(),40);
      loadAudioUI(cell);
      preflightMic();
    }
    function closeModal(){
      try{ stopRec(); }catch(e){}
      dlg.close(); currentId=null;
    }
    function updateCount(){ count.textContent = (resp.value.length||0) + '/800 caract√®res'; }
    resp.addEventListener('input', updateCount);

    function mountKeyboard(){
      kbd.innerHTML=''; ACCENTS.forEach(ch=>{ const b=document.createElement('button'); b.type='button'; b.textContent=ch; b.addEventListener('click',()=>insertAtCursor(resp,ch)); kbd.appendChild(b); });
    }
    function insertAtCursor(field, text){
      const start=field.selectionStart, end=field.selectionEnd; const v=field.value;
      field.value=v.slice(0,start)+text+v.slice(end); field.selectionStart=field.selectionEnd=start+text.length; field.focus(); updateCount();
    }

    saveBtn.addEventListener('click',()=>{
      if(currentId==null) return; const cell=board.find(c=>c.id===currentId);
      cell.response=resp.value.slice(0,800); cell.completed = cell.free || cell.response.trim().length>=10 || !!cell.audio; save(); render(); updateProgress(); showToast('Enregistr√© ‚úÖ'); closeModal();
    });
    clearCellBtn.addEventListener('click',()=>{
      if(currentId==null) return; const cell=board.find(c=>c.id===currentId);
      cell.response=''; if(!cell.free && !cell.audio) cell.completed=false; save(); render(); updateProgress(); showToast('R√©ponse effac√©e'); resp.value=''; updateCount();
    });
    closeDlg.addEventListener('click', closeModal);

    // ---------- Audio recording (MediaRecorder) + Fallback Upload ----------
    const recBtn=document.getElementById('recBtn');
    const stopBtn=document.getElementById('stopBtn');
    const playBtn=document.getElementById('playBtn');
    const delAudioBtn=document.getElementById('delAudioBtn');
    const uploadBtn=document.getElementById('uploadBtn');
    const uploadInput=document.getElementById('uploadInput');
    const audioEl=document.getElementById('audio');
    const timerEl=document.getElementById('timer');
    let mediaStream=null, mediaRec=null, chunks=[], t0=0, tick=null;

    function hhmm(s){const m=Math.floor(s/60), ss=('0'+(s%60)).slice(-2); return ("0"+m).slice(-2)+":"+ss;}

    async function preflightMic(){
      try{
        if(!('mediaDevices' in navigator) || !('MediaRecorder' in window)){
          recBtn.disabled=true; stopBtn.disabled=true; playBtn.disabled=true; delAudioBtn.disabled=true;
          permWarn.style.display='block'; permWarn.textContent='Enregistrement audio non support√© par ce navigateur.'; return;
        }
        if(navigator.permissions && navigator.permissions.query){
          try{ const st = await navigator.permissions.query({name:'microphone'}); if(st.state==='denied'){ permWarn.style.display='block'; permWarn.textContent='Micro refus√©. Autorise le microphone dans les param√®tres du navigateur.'; } }catch(e){}
        }
      }catch(e){}
    }

    async function startRec(){
      try{
        if(!navigator.mediaDevices || !window.MediaRecorder){ showToast('Audio non support√©'); return; }
        mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRec = new MediaRecorder(mediaStream);
        chunks=[]; mediaRec.ondataavailable=e=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
        mediaRec.onstop=async ()=>{
          try{
            const blob=new Blob(chunks, {type:mediaRec.mimeType || 'audio/webm'});
            const reader=new FileReader(); reader.onloadend=()=>{
              const dataUrl=reader.result; const cell=board.find(c=>c.id===currentId); if(!cell) return;
              cell.audio={dataUrl, mime: blob.type || 'audio/webm'}; cell.completed = true; save(); render(); updateProgress();
              audioEl.src=dataUrl; audioEl.style.display='block'; playBtn.disabled=false; delAudioBtn.disabled=false; showToast('Audio enregistr√© üéôÔ∏è');
            }; reader.readAsDataURL(blob);
          }catch(e){ console.error(e); showToast('Erreur lors de la sauvegarde audio'); }
          cleanupStream();
        };
        mediaRec.start();
        recBtn.disabled=true; stopBtn.disabled=false; playBtn.disabled=true; delAudioBtn.disabled=true;
        t0=Date.now(); timerEl.textContent='00:00'; tick=setInterval(()=>{ const s=Math.floor((Date.now()-t0)/1000); timerEl.textContent=hhmm(s); }, 250);
      }catch(err){
        console.error(err);
        if(err && (err.name==='NotAllowedError' || err.name==='NotFoundError')){
          permWarn.style.display='block';
          permWarn.textContent='Micro non accessible. Autorise le microphone et/ou utilise ¬´¬†Importer audio¬†¬ª.';
        }
        showToast('Micro non accessible');
        cleanupStream();
      }
    }
    function stopRec(){ try{ if(mediaRec && mediaRec.state!=='inactive') mediaRec.stop(); }catch(e){} stopBtn.disabled=true; recBtn.disabled=false; clearInterval(tick); tick=null; }
    function cleanupStream(){ try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){} mediaStream=null; mediaRec=null; clearInterval(tick); tick=null; timerEl.textContent='00:00'; }

    function loadAudioUI(cell){
      if(cell && cell.audio){ audioEl.src=cell.audio.dataUrl; audioEl.style.display='block'; playBtn.disabled=false; delAudioBtn.disabled=false; }
      else { audioEl.removeAttribute('src'); audioEl.style.display='none'; playBtn.disabled=true; delAudioBtn.disabled=true; }
      stopBtn.disabled=true; recBtn.disabled=false; timerEl.textContent='00:00';
    }

    // Fallback: upload audio file
    uploadBtn.addEventListener('click', ()=>uploadInput.click());
    uploadInput.addEventListener('change', ()=>{
      const file=uploadInput.files && uploadInput.files[0]; if(!file) return;
      const reader=new FileReader(); reader.onload=()=>{
        if(currentId==null) return; const cell=board.find(c=>c.id===currentId); if(!cell) return;
        cell.audio={dataUrl: reader.result, mime: file.type || 'audio/*'}; cell.completed=true; save(); render(); updateProgress();
        audioEl.src=reader.result; audioEl.style.display='block'; playBtn.disabled=false; delAudioBtn.disabled=false; showToast('Audio import√© üì§');
      }; reader.readAsDataURL(file);
      uploadInput.value='';
    });

    recBtn.addEventListener('click', ()=>{ startRec().catch(()=>{}); });
    stopBtn.addEventListener('click', ()=>{ try{ stopRec(); }catch(e){} });
    playBtn.addEventListener('click', ()=>{ if(!audioEl.src) return; audioEl.play(); });
    delAudioBtn.addEventListener('click', ()=>{
      if(currentId==null) return; const cell=board.find(c=>c.id===currentId); if(!cell) return;
      delete cell.audio; if(!cell.free && !(cell.response && cell.response.trim().length>=10)) cell.completed=false; save(); loadAudioUI(cell); render(); updateProgress(); showToast('Audio supprim√©');
    });

    // ---------- Wire top controls ----------
    (function wire(){
      const shuffleBtn=document.getElementById('shuffleBtn');
      const clearBtn=document.getElementById('clearBtn');
      const exportBtn=document.getElementById('exportBtn');
      if(shuffleBtn) shuffleBtn.addEventListener('click',()=>{ if(confirm('M√©langer r√©initialise les invites et supprime les r√©ponses & audios. Continuer ?')){ localStorage.removeItem(LS_KEY); buildBoard(); showToast('M√©lang√© üé≤'); }});
      if(clearBtn) clearBtn.addEventListener('click',()=>{ if(confirm('Effacer toutes les r√©ponses & audios ?')){ board.forEach(c=>{c.response=''; delete c.audio; c.completed=!!c.free;}); save(); render(); updateProgress(); showToast('R√©initialis√©'); }});
      if(exportBtn) exportBtn.addEventListener('click',()=>{
        const rows=[["#","Type","Invite","R√©ponse","Audio?","Compl√©t√©e"]];
        board.forEach((c,i)=>rows.push([i+1, c.free?'CARTE LIBRE':'T√ÇCHE', c.prompt.replace(/\n/g,' '), (c.response||'').replace(/\n/g,' '), c.audio?'oui':'non', c.completed?'oui':'non']));
        const csv=rows.map(r=>r.map(x=>('"'+String(x).replace(/"/g,'""')+'"')).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bingo-ib-frenchb.csv'; a.click(); URL.revokeObjectURL(url); showToast('CSV export√©');
      });
    })();

    // ---------- Tests ----------
    // Do NOT auto-open the modal on load anymore.
    // Keep tests lightweight and UI-safe (no clicks).
    const RUN_TESTS = new URLSearchParams(location.search).get('test') === '1';
    function __runTests(){
      console.log('%cRunning sanity tests‚Ä¶','color:#22d3ee');
      const pool=getPromptPool();
      console.assert(Array.isArray(pool) && pool.length===24, 'Expected pool length = 24');
      console.assert(pool.every(p=>p && typeof p.t==='string' && p.t.length>0), 'All prompts must have a non-empty .t');
      buildBoard();
      console.assert(gridEl.children.length===25, 'Grid should have 25 cells');
      console.assert(gridEl.children[12].classList.contains('free'), 'Center cell should be free');
      // Bingo detection test
      for(let c=0;c<5;c++){ board[c].completed=true; }
      updateProgress();
      const anyBingo = LINES.some(line=>line.every(i=>board[i].completed));
      console.assert(anyBingo===true, 'At least one bingo line should be detected after marking first row');
      // Modal presence test (no auto-open)
      console.assert(document.getElementById('dlg') instanceof HTMLDialogElement, 'Dialog element exists');
      console.assert(document.getElementById('dlg').open===false, 'Dialog should NOT be open on load');
      // Chunk insertion test (simulate only on a detached textarea)
      const fake = document.createElement('textarea'); fake.value='X';
      function insertTmp(t){ const s=fake.selectionStart||1, e=fake.selectionEnd||1; fake.value=fake.value.slice(0,s)+t+fake.value.slice(e); }
      const exampleChunk=(CHUNKS[0] && CHUNKS[0].text) || ''; insertTmp(exampleChunk);
      console.assert(fake.value.includes(exampleChunk), 'Chunk insertion logic works in isolation');
      // Clipboard test (does not throw)
      const copied = copyMaybe('test'); console.assert(typeof copied==='boolean', 'copyMaybe returns a boolean without throwing');
      // Upload fallback test (logic only)
      (function fakeUpload(){
        const cell=board[0]; const dummy='data:audio/webm;base64,AAAA';
        cell.audio={dataUrl:dummy, mime:'audio/webm'}; cell.completed=true; save(); updateProgress();
        console.assert(board[0].audio && board[0].audio.dataUrl===dummy, 'Audio set via fallback upload');
      })();
      // Media API presence (no permission requirement)
      console.assert('mediaDevices' in navigator, 'navigator.mediaDevices should exist in modern browsers');
      console.log('%cAll tests passed','color:#34d399');
    }
    if(RUN_TESTS){ __runTests(); }

    // ---------- Init ----------
    function mountKeyboardInit(){ mountKeyboard(); }
    mountKeyboardInit();
    // Explicitly ensure dialog is closed on load
    try{ if(dlg.open) dlg.close(); }catch(e){}
    // As an extra safety in aggressive previewers: close any auto-open within the first second
    setTimeout(()=>{ try{ if(dlg.open) dlg.close(); }catch(e){} }, 800);
    load();
  </script>
</body>
</html>
