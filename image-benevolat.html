<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IB French B ‚Äì Bingo (B√©n√©volat) + Constructeur de phrases (TTS)</title>
  <style>
    :root{
      --bg:#0c1222; --card:#0f172a; --text:#e6edf6; --muted:#a6b4c9; --brand:#06b6d4; --accent:#f59e0b; --good:#22c55e; --shadow:0 14px 40px rgba(0,0,0,.35);
      --free-bg:linear-gradient(180deg, rgba(6,182,212,.25), rgba(245,158,11,.25));
    }
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans"; color:var(--text); background:radial-gradient(1200px 560px at 15% -5%, #17223f 0%, #0c1222 60%) fixed}
    .wrap{max-width:1200px; margin:0 auto; padding:24px 18px 96px}
    .tabHeader{display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-bottom:16px}
    .tabBtn{padding:10px 18px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(6,182,212,.12); color:var(--text); cursor:pointer}
    .tabBtn.active{background:var(--brand); color:#06232a}
    .tabContent{display:none}
    .tabContent.active{display:block}

    header{display:grid; grid-template-columns:1fr; gap:16px; align-items:center; margin-bottom:18px}
    @media(min-width:900px){header{grid-template-columns:1.25fr .95fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.09); border-radius:18px; box-shadow:var(--shadow)}
    .imgCard{position:relative; overflow:hidden}
    .imgCard img{display:block; width:100%; height:100%; object-fit:cover; border-radius:16px}
    .imgInfo{position:absolute; inset:auto 12px 12px 12px; background:rgba(0,0,0,.5); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; font-size:.92rem}
    .zoomBtn{position:absolute; top:12px; right:12px; z-index:5}
    .zoomCanvas{cursor:grab}
    .zoomCanvas:active{cursor:grabbing}
    .zoomToolbar{display:flex; gap:8px; justify-content:flex-end; padding:10px}
    .zoomStage{position:relative; width:min(1100px,92vw); height:min(72vh,780px); background:#000; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.15)}
    .zoomStage img{user-select:none; -webkit-user-drag:none; touch-action:none; will-change:transform}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.14); color:var(--text); background:linear-gradient(180deg, rgba(6,182,212,.14), rgba(245,158,11,.12)); cursor:pointer; transition:.15s transform ease, .2s filter ease; user-select:none}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}

    .grid{margin-top:16px; display:grid; grid-template-columns:repeat(5,1fr); gap:10px}
    .cell{min-height:130px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025)); border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:12px; position:relative; overflow:hidden; cursor:pointer; transition:.15s transform ease, .25s box-shadow ease}
    .cell:hover{box-shadow:0 10px 26px rgba(6,182,212,.22); transform:translateY(-2px)}
    .cell h4{margin:0 0 6px; font-size:.95rem; color:#6fe7ff}
    .cell.free{background:var(--free-bg)}
    .cell.free h4{color:#e2e8f0; text-shadow:0 0 8px rgba(6,182,212,.6)}
    .cell p{margin:0; font-size:.92rem; color:var(--text)}
    .badge{position:absolute; top:8px; right:8px; font-size:.75rem; background:rgba(34,197,94,.18); color:#d1fae5; border:1px solid rgba(34,197,94,.35); padding:4px 8px; border-radius:999px; display:none}
    .cell.completed .badge{display:inline-block}
    .assist{margin-top:6px; font-size:.8rem; color:var(--muted)}

    .chunkBank{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:8px; background:rgba(255,255,255,.05); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,.1)}
    .chunk{background:rgba(6,182,212,.12); border:1px solid rgba(6,182,212,.25); border-radius:10px; padding:8px; font-size:.9rem; text-align:center}

    .progress{display:flex; align-items:center; gap:12px; margin-top:10px}
    .mini{display:grid; grid-template-columns:repeat(5,10px); gap:4px; padding:6px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:rgba(255,255,255,.04)}
    .mini div{width:10px;height:10px;border-radius:2px;background:#374151}
    .mini div.done{background:var(--good)}
    .bingoTag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background:rgba(34,197,94,.15); color:#d1fae5}

    /* Modal */
    dialog{border:none; border-radius:16px; padding:0; background:transparent}
    .modal{width:min(780px,94vw); background:linear-gradient(180deg,#0a1224,#0a0f1a); border:1px solid rgba(255,255,255,.12); border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .modal header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.09)}
    .modal .body{display:grid; grid-template-columns:1fr; gap:12px; padding:14px 16px}
    .modal .prompt{font-size:.98rem; color:#e2e8f0}
    .kbdRow{display:flex; flex-wrap:wrap; gap:8px; padding:10px; border:1px dashed rgba(255,255,255,.18); border-radius:12px; background:rgba(255,255,255,.04)}
    .kbdRow button{padding:6px 10px; border-radius:8px; background:#0b1526; color:#e5e7eb; border:1px solid rgba(255,255,255,.14); cursor:pointer}
    textarea{width:100%; min-height:140px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0b1526; color:var(--text); resize:vertical}
    .modal footer{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:14px 16px; border-top:1px solid rgba(255,255,255,.09)}
    .hint{font-size:.85rem; color:var(--muted)}

    /* Sentence Builder */
    .builder{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1); border-radius:14px; padding:12px}
    .builderGrid{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:800px){.builderGrid{grid-template-columns:repeat(2,1fr)}}
    .builderRow{display:flex; gap:8px; align-items:center}
    .builderRow label{min-width:110px; color:#cfe2ff}
    .builderRow select, .builderRow input[type="text"]{flex:1; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1526; color:var(--text)}
    .outSentence{margin-top:10px; padding:10px; border-radius:10px; background:#0b1526; border:1px solid rgba(255,255,255,.14)}
    .ttsBar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="tabHeader">
      <button class="tabBtn active" data-tab="bingo" type="button">üéØ Bingo ‚Äì B√©n√©volat</button>
      <button class="tabBtn" data-tab="chunks" type="button">üí¨ Banque de chunks</button>
      <button class="tabBtn" data-tab="builder" type="button">üß© Constructeur de phrases (TTS)</button>
    </div>

    <!-- BINGO MODULE -->
    <div id="bingo" class="tabContent active">
      <header>
        <section class="card imgCard">
          <button class="btn zoomBtn" id="zoomOpen" type="button">üîç Zoomer</button>
          <img src="https://www.infoj.be/wp-content/uploads/2022/07/7-1.png" alt="Affiche b√©n√©volat" />
          <div class="imgInfo"><strong>D√©clencheur visuel</strong> ‚Äî Quelles actions de b√©n√©volat vois-tu ? Quels besoins / impacts ?</div>
        </section>
        <section class="card" style="padding:14px 16px">
          <h2 style="margin:8px 0 12px">Bingo d‚Äôexpression orale ‚Äì IB French B (SL) ‚Äì B√©n√©volat</h2>
          <div class="controls">
            <button class="btn" id="bn-shuffle" type="button">üîÄ M√©langer</button>
            <button class="btn" id="bn-clear" type="button">üßπ Effacer</button>
            <button class="btn" id="bn-export" type="button">‚¨áÔ∏è Exporter</button>
            <div class="progress"><div class="mini" id="bn-mini"></div><span id="bn-count">0/25</span><span class="bingoTag" id="bn-bingo" style="display:none">üéâ BINGO !</span></div>
          </div>
        </section>
      </header>
      <section class="grid" id="bn-grid"></section>
    </div>

    <!-- CHUNK BANK -->
    <div id="chunks" class="tabContent">
      <h2>üí¨ Banque de chunks ‚Äì b√©n√©volat</h2>
      <div class="card" style="padding:12px; margin-bottom:10px">
        <div id="chunkFilters" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center">
          <strong style="margin-right:6px">Cat√©gories¬†:</strong>
          <button class="btn" data-cat="all" type="button">Toutes</button>
          <button class="btn" data-cat="amorces" type="button">Amorces</button>
          <button class="btn" data-cat="verbes" type="button">Verbes</button>
          <button class="btn" data-cat="descriptions" type="button">Descriptions</button>
          <button class="btn" data-cat="connecteurs" type="button">Connecteurs</button>
          <button class="btn" data-cat="nuancer" type="button">Nuancer</button>
          <button class="btn" data-cat="interaction" type="button">Interaction</button>
          <button class="btn" data-cat="donnees" type="button">Donn√©es</button>
          <input id="chunkSearch" type="search" placeholder="Rechercher‚Ä¶" style="margin-left:auto; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1526; color:var(--text); min-width:200px" />
        </div>
      </div>
      <div class="chunkBank" id="chunkBank"></div>
    </div>

    <!-- SENTENCE BUILDER + TTS -->
    <div id="builder" class="tabContent">
      <h2>üß© Constructeur de phrases ‚Äì b√©n√©volat (avec TTS)</h2>
      <div class="builder">
        <div class="builderGrid">
          <div class="builderRow"><label>Sujet</label>
            <select id="sb-subj">
              <option>Je</option><option>Nous</option><option>On</option><option>Les √©l√®ves</option><option>La communaut√©</option>
            </select>
          </div>
          <div class="builderRow"><label>Verbe</label>
            <select id="sb-verb">
              <option>aide</option><option>aidons</option><option>s&rsquo;engage</option><option>organise</option><option>participe</option><option>collecte</option><option>sensibilise</option>
            </select>
          </div>
          <div class="builderRow"><label>Compl√©ment</label>
            <select id="sb-comp">
              <option>√† la banque alimentaire</option><option>des v√™tements pour les sans-abri</option><option>√† une collecte de fonds</option><option>les personnes √¢g√©es</option><option>des fournitures scolaires</option>
            </select>
          </div>
          <div class="builderRow"><label>But / Impact</label>
            <select id="sb-impact">
              <option>pour lutter contre l&rsquo;ins√©curit√© alimentaire</option><option>afin de soutenir les familles locales</option><option>pour am√©liorer le bien-√™tre de la communaut√©</option><option>afin de d√©velopper l&rsquo;esprit de solidarit√©</option>
            </select>
          </div>
          <div class="builderRow"><label>Connecteur</label>
            <select id="sb-conn">
              <option>Cet engagement est important car</option><option>De plus,</option><option>Cependant,</option><option>En cons√©quence,</option>
            </select>
          </div>
          <div class="builderRow"><label>Suite</label>
            <input id="sb-suite" type="text" placeholder="‚Ä¶ il r√©duit l‚Äôisolement / ‚Ä¶ il cr√©e des liens, etc." />
          </div>
        </div>
        <div class="outSentence" id="sb-out">Je aide √† la banque alimentaire pour lutter contre l‚Äôins√©curit√© alimentaire. Cet engagement est important car ‚Ä¶</div>
        <div class="ttsBar">
          <button class="btn" id="sb-copy" type="button">üìã Copier</button>
          <button class="btn" id="sb-insert" type="button">‚ÜóÔ∏è Ins√©rer dans la r√©ponse</button>
          <button class="btn" id="sb-speak" type="button">üîä Lire (TTS)</button>
          <label for="sb-voice" class="hint">Voix :</label>
          <select id="sb-voice"></select>
          <label for="sb-rate" class="hint">Vitesse :</label>
          <input id="sb-rate" type="range" min="0.6" max="1.4" value="1" step="0.1" />
        </div>
        <p class="hint" id="ttsWarn" style="display:none;margin-top:6px">La synth√®se vocale n‚Äôest pas disponible sur ce navigateur / appareil.</p>
      </div>
    </div>
  </div>

  <!-- Modal (responses + accents + audio) -->
  <dialog id="dlg">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h3 id="dlgTitle">R√©ponds √† la t√¢che</h3>
        <button class="btn" id="closeDlg" type="button">‚úñ</button>
      </header>
      <div class="body">
        <div class="prompt" id="dlgPrompt"></div>
        <label for="resp" class="hint">Ta r√©ponse :</label>
        <textarea id="resp" placeholder="√âcris ici‚Ä¶"></textarea>
        <div>
          <div class="hint" style="margin-bottom:6px"><strong>Clavier d‚Äôaccents</strong> : clique pour ins√©rer</div>
          <div class="kbdRow" id="kbd"></div>
        </div>
        <div class="audioBar">
          <button class="btn rec" id="recBtn" type="button">‚è∫Ô∏è Enregistrer</button>
          <button class="btn" id="stopBtn" type="button" disabled>‚èπÔ∏è Stop</button>
          <button class="btn" id="playBtn" type="button" disabled>‚ñ∂Ô∏è √âcouter</button>
          <button class="btn" id="delAudioBtn" type="button" disabled>üóëÔ∏è Supprimer audio</button>
          <button class="btn" id="uploadBtn" type="button">üì§ Importer audio</button>
          <input id="uploadInput" type="file" accept="audio/*" style="display:none" />
          <span class="hint timer" id="timer">00:00</span>
          <audio id="audio" controls style="display:none; width:100%"></audio>
        </div>
        <div id="permWarn" class="permWarn">Micro non accessible. Autorise le micro ou utilise ¬´¬†Importer audio¬†¬ª.</div>
      </div>
      <footer>
        <span class="hint" id="count">0/800 caract√®res</span>
        <div style="display:flex; gap:8px">
          <button class="btn" id="save" type="button">üíæ Enregistrer</button>
          <button class="btn" id="clearCell" type="button">Effacer la r√©ponse</button>
        </div>
      </footer>
    </div>
  </dialog>

  <!-- Image Zoom Dialog -->
  <dialog id="imgZoom">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <h3>Zoom ‚Äì Affiche b√©n√©volat</h3>
        <button class="btn" id="zoomClose" type="button">‚úñ</button>
      </header>
      <div class="zoomToolbar">
        <button class="btn" id="zIn" type="button">Ôºã</button>
        <button class="btn" id="zOut" type="button">Ôºç</button>
        <button class="btn" id="zReset" type="button">‚§æ R√©initialiser</button>
        <a class="btn" href="https://www.infoj.be/wp-content/uploads/2022/07/7-1.png" target="_blank" rel="noopener">‚ÜóÔ∏è Ouvrir l‚Äôimage</a>
      </div>
      <div class="zoomStage">
        <img id="zoomImg" class="zoomCanvas" src="https://www.infoj.be/wp-content/uploads/2022/07/7-1.png" alt="Affiche b√©n√©volat ‚Äì zoom" />
      </div>
      <footer style="padding:10px 14px"><span class="hint">Astuce¬†: molette pour zoomer, glisser pour d√©placer, double‚Äëclic pour centrer.</span></footer>
    </div>
  </dialog>

  <div class="toast" id="toast" id="toast" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0b1526;border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:10px;display:none">Action effectu√©e</div>

  <script>
    // ---------- Utils ----------
    const toast=document.getElementById('toast');
    function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1300); }
    const ACCENTS=['√†','√¢','√§','√¶','√ß','√©','√®','√™','√´','√Æ','√Ø','√¥','≈ì','√∂','√π','√ª','√º','√ø','√Ä','√á','√â','√à','√ä','√ã','√é','√è','√î','√ô','√õ','√ú','¬´','¬ª','‚Ç¨'];

    // ---------- Chunk bank ----------
    const CHUNKS=[
      {cat:'amorces',text:'√Ä mon avis, ‚Ä¶'},{cat:'amorces',text:'Selon moi, ‚Ä¶'},{cat:'amorces',text:"Il me semble que ‚Ä¶"},{cat:'amorces',text:"D‚Äôapr√®s cette affiche, ‚Ä¶"},
      {cat:'verbes',text:'aider / s‚Äôengager / participer / organiser / sensibiliser / collecter'},
      {cat:'verbes',text:'soutenir / encadrer / accompagner / am√©liorer'},
      {cat:'descriptions',text:'banque alimentaire / foyer / association / collecte / dons'},
      {cat:'descriptions',text:'b√©n√©ficiaires / b√©n√©voles / besoins / impact'},
      {cat:'connecteurs',text:'d‚Äôabord / ensuite / enfin'},{cat:'connecteurs',text:'parce que / donc / cependant'},
      {cat:'nuancer',text:'Je comprends cette objection, mais ‚Ä¶'},{cat:'nuancer',text:'Tout en reconnaissant‚Ä¶, on peut dire que ‚Ä¶'},
      {cat:'interaction',text:'Qu‚Äôen penses-tu ?'},{cat:'interaction',text:'Peux-tu pr√©ciser avec un exemple ?'},
      {cat:'donnees',text:'heures de service / b√©n√©ficiaires / objectifs mesurables'},
      {cat:'donnees',text:'impact : court terme vs long terme'},
    ];
    const chunkFilters=document.getElementById('chunkFilters');
    const chunkBank=document.getElementById('chunkBank');
    const chunkSearch=document.getElementById('chunkSearch');
    function renderChunks(){
      if(!chunkBank) return; const q=(chunkSearch&&chunkSearch.value?chunkSearch.value:'').toLowerCase().trim();
      chunkBank.innerHTML=''; const activeCat=renderChunks.activeCat||'all';
      CHUNKS.filter(c=>activeCat==='all'||c.cat===activeCat).filter(c=>!q||c.text.toLowerCase().includes(q)).forEach(c=>{
        const div=document.createElement('div'); div.className='chunk'; div.textContent=c.text; div.title=c.cat; div.addEventListener('click',()=>{ if(dlg.open){ insertAtCursor(resp,(resp.value&&!resp.value.endsWith('\n')?' ':' ')+c.text+' '); } else { showToast('Copi√© (si autoris√©)'); navigator.clipboard?.writeText?.(c.text).catch(()=>{}); } }); chunkBank.appendChild(div);
      });
    }
    if(chunkFilters){
      chunkFilters.addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-cat]'); if(!btn) return; renderChunks.activeCat=btn.dataset.cat; [...chunkFilters.querySelectorAll('button[data-cat]')].forEach(b=>b.classList.toggle('active',b===btn)); renderChunks(); });
      const allBtn=chunkFilters.querySelector('button[data-cat="all"]'); if(allBtn) allBtn.classList.add('active');
    }
    chunkSearch?.addEventListener('input',renderChunks);

    // ---------- Bingo (B√©n√©volat) ----------
    const grid=document.getElementById('bn-grid');
    const mini=document.getElementById('bn-mini');
    const countEl=document.getElementById('bn-count');
    const bingoTag=document.getElementById('bn-bingo');
    const LINES=(()=>{ const rows=[0,5,10,15,20].map(s=>[s,s+1,s+2,s+3,s+4]); const cols=[0,1,2,3,4].map(c=>[c,c+5,c+10,c+15,c+20]); const diags=[[0,6,12,18,24],[4,8,12,16,20]]; return [...rows,...cols,...diags]; })();
    const LS_KEY='ibfb-benevolat-v1';
    const EPHEMERAL=(new URLSearchParams(location.search).get('persist')!=='1');
    let board=[]; if(!EPHEMERAL){ try{ const raw=localStorage.getItem(LS_KEY); if(raw) board=JSON.parse(raw)||[]; }catch(e){} }

    const PROMPTS=[
      {t:'D√©cris l‚Äôaffiche : qui, quoi, o√π ?'},
      {t:'Pourquoi faire du b√©n√©volat ? Donne deux raisons.'},
      {t:'Pr√©sente une association locale et sa mission.'},
      {t:'Imagine une action concr√®te cette semaine.'},
      {t:'Quels besoins observes-tu dans ta communaut√© ?'},
      {t:'Comment mesurer l‚Äôimpact d‚Äôune action b√©n√©vole ?'},
      {t:'R√©dige une consigne pour recruter des b√©n√©voles.'},
      {t:'Propose un slogan efficace.'},
      {t:'D√©cris un obstacle et une solution.'},
      {t:'Compare b√©n√©volat ponctuel vs r√©gulier.'},
      {t:'Explique le r√¥le des r√©seaux sociaux.'},
      {t:'Raconte une courte exp√©rience (r√©elle ou fictive).'},
      {t:'Subjonctif : ¬´ Il faut que‚Ä¶ ¬ª pour organiser un √©v√©nement.'},
      {t:'Exprime une concession : ¬´ Bien que‚Ä¶ ¬ª'},
      {t:'√âthique : comment respecter la dignit√© des b√©n√©ficiaires ?'},
      {t:'Partenariats¬†: √©cole, mairie, entreprises ?'},
      {t:'Dresse une liste de t√¢ches pour le jour J.'},
      {t:'R√¥le des √©l√®ves¬†: qui fait quoi ?'},
      {t:'Budget¬†: de quoi a-t-on besoin ?'},
      {t:'Communication¬†: affiche, annonce, post ?'},
      {t:"Identifie un risque concret (ex. manque de b√©n√©voles) et propose un plan B pr√©cis (qui fait quoi, quand)."},
      {t:'Cr√©e une mini‚Äëinterview d‚Äôun b√©n√©vole (3 Q/R).'},
      {t:'Exprime de la gratitude envers des partenaires.'},
      {t:'R√©dige un texte pour convaincre un parent.'},
      {t:'Conclue¬†: quel impact esp√®res‚Äëtu ?'}
    ];

    function pool(){
      const valid=PROMPTS.filter(p=>p&&typeof p.t==='string'&&p.t.trim());
      const need=24-valid.length; const fillers=[]; for(let i=1;i<=Math.max(0,need);i++){ fillers.push({t:`T√¢che suppl√©mentaire ${i} : pr√©cise une action b√©n√©vole et son impact.`}); }
      return [...valid,...fillers].sort(()=>Math.random()-.5).slice(0,24);
    }
    function build(){ const p=pool(); let k=0; const cells=[]; for(let i=0;i<25;i++){ if(i===12) cells.push({id:`bn-c12`,prompt:'Propose ton propre angle d‚Äôanalyse.',response:'',completed:true,free:true}); else { const it=p[k++]; const text=(it&&it.t)||'D√©cris un d√©tail et son sens.'; cells.push({id:`bn-c${i}`,prompt:text,response:'',completed:false,free:false}); } } board=cells; save(); render(); update(); }
    function render(){ grid.innerHTML=''; board.forEach(c=>{ const el=document.createElement('button'); el.type='button'; el.className='cell'+(c.free?' free':'')+(c.completed?' completed':''); el.dataset.id=c.id; el.innerHTML=(c.free?'<h4>CARTE LIBRE</h4>':'<h4>T√ÇCHE</h4>')+`<p>${c.prompt}</p>`+`<span class=\"badge\">Fait</span>`+(c.response?`<div class=\"assist\">R√©ponse sauvegard√©e ‚úì</div>`:'')+(c.audio?`<div class=\"assist\">üéôÔ∏è Audio enregistr√©</div>`:''); el.addEventListener('click',()=>openCell(c.id)); grid.appendChild(el); }); }
    function update(){ mini.innerHTML=''; board.forEach(c=>{ const d=document.createElement('div'); if(c.completed) d.classList.add('done'); mini.appendChild(d); }); const done=board.filter(c=>c.completed).length; countEl.textContent=done+'/25'; const lines=LINES.filter(L=>L.every(i=>board[i].completed)); bingoTag.style.display=lines.length?'inline-flex':'none'; if(lines.length) showToast('üéâ BINGO !'); }
    function save(){ if(EPHEMERAL) return; try{ localStorage.setItem(LS_KEY, JSON.stringify(board)); }catch(e){} }
    function clearAll(){ board.forEach(c=>{c.response=''; delete c.audio; c.completed=!!c.free;}); save(); render(); update(); }
    function exportCSV(){ const rows=[["#","Type","Invite","R√©ponse","Audio?","Compl√©t√©e"]]; board.forEach((c,i)=>rows.push([i+1,c.free?'CARTE LIBRE':'T√ÇCHE',c.prompt.replace(/\n/g,' '),(c.response||'').replace(/\n/g,' '),c.audio?'oui':'non',c.completed?'oui':'non'])); const csv=rows.map(r=>r.map(x=>('"'+String(x).replace(/"/g,'""')+'"')).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bingo-benevolat.csv'; a.click(); URL.revokeObjectURL(url); }

    document.getElementById('bn-shuffle')?.addEventListener('click',()=>{ if(confirm('M√©langer r√©initialise les invites et supprime les r√©ponses & audios. Continuer ?')){ if(!EPHEMERAL) localStorage.removeItem(LS_KEY); build(); }});
    document.getElementById('bn-clear')?.addEventListener('click',()=>{ if(confirm('Effacer toutes les r√©ponses & audios ?')) clearAll(); });
    document.getElementById('bn-export')?.addEventListener('click',exportCSV);

    if(!board.length) build(); else { render(); update(); }

    // ---------- Tabs ----------
    document.querySelectorAll('.tabBtn').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tabContent').forEach(c=>c.classList.remove('active'));
      btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active');
    }));

    // ---------- Image Zoom ----------
    const zoomOpen=document.getElementById('zoomOpen');
    const zoomClose=document.getElementById('zoomClose');
    const imgZoom=document.getElementById('imgZoom');
    const zoomImg=document.getElementById('zoomImg');
    const zIn=document.getElementById('zIn');
    const zOut=document.getElementById('zOut');
    const zReset=document.getElementById('zReset');
    let zScale=1, zX=0, zY=0, dragging=false, pX=0, pY=0;
    function applyZoom(){ zoomImg.style.transform=`translate(${zX}px, ${zY}px) scale(${zScale})`; zoomImg.style.transformOrigin='0 0'; }
    function resetZoom(){ zScale=1; zX=0; zY=0; applyZoom(); }
    function clamp(val,min,max){ return Math.max(min, Math.min(max,val)); }
    function zoomAt(cx,cy,delta){ const prev=zScale; zScale=clamp(zScale*(delta>0?1.15:1/1.15), 1, 6); const rect=zoomImg.getBoundingClientRect(); const dx=cx-rect.left; const dy=cy-rect.top; zX = dx - (zScale/prev)*(dx - zX); zY = dy - (zScale/prev)*(dy - zY); applyZoom(); }
    zoomOpen?.addEventListener('click',()=>{ try{ if(!imgZoom.open && imgZoom.showModal) imgZoom.showModal(); else imgZoom.setAttribute('open',''); }catch(e){ imgZoom.setAttribute('open',''); imgZoom.style.display='block'; }
      setTimeout(resetZoom,0);
    });
    zoomClose?.addEventListener('click',()=>{ try{ imgZoom.close?.(); }catch(e){}
      imgZoom.removeAttribute('open'); imgZoom.style.display='none';
    });
    zIn?.addEventListener('click',()=>{ zScale=Math.min(6, zScale*1.2); applyZoom(); });
    zOut?.addEventListener('click',()=>{ zScale=Math.max(1, zScale/1.2); applyZoom(); });
    zReset?.addEventListener('click',resetZoom);
    zoomImg?.addEventListener('wheel',(e)=>{ e.preventDefault(); zoomAt(e.clientX,e.clientY, e.deltaY); }, {passive:false});
    zoomImg?.addEventListener('pointerdown',(e)=>{ dragging=true; pX=e.clientX; pY=e.clientY; zoomImg.setPointerCapture(e.pointerId); });
    zoomImg?.addEventListener('pointermove',(e)=>{ if(!dragging) return; zX += e.clientX - pX; zY += e.clientY - pY; pX=e.clientX; pY=e.clientY; applyZoom(); });
    zoomImg?.addEventListener('pointerup',()=>{ dragging=false; });
    zoomImg?.addEventListener('dblclick',()=>resetZoom());

    // ---------- Modal & keyboard ----------
    const dlg=document.getElementById('dlg'); const resp=document.getElementById('resp'); const closeDlg=document.getElementById('closeDlg'); const saveBtn=document.getElementById('save'); const clearCellBtn=document.getElementById('clearCell'); const count=document.getElementById('count'); const kbd=document.getElementById('kbd'); let currentId=null;
    function openCell(id){ currentId=id; const cell=board.find(c=>c.id===id); document.getElementById('dlgPrompt').innerHTML=(cell.free?'<strong>CARTE LIBRE</strong> ‚Äì ':'<strong>T√ÇCHE</strong> ‚Äì ')+cell.prompt; resp.value=cell.response||''; updateCount(); if(!dlg.open) dlg.showModal(); setTimeout(()=>resp.focus(),40); loadAudioUI(cell); preflightMic(); }
    function updateCount(){ count.textContent=(resp.value.length||0)+'/800 caract√®res'; }
    function insertAtCursor(field,text){ const s=field.selectionStart,e=field.selectionEnd,v=field.value; field.value=v.slice(0,s)+text+v.slice(e); field.selectionStart=field.selectionEnd=s+text.length; field.focus(); updateCount(); }
    function mountKeyboard(){ kbd.innerHTML=''; ACCENTS.forEach(ch=>{ const b=document.createElement('button'); b.type='button'; b.textContent=ch; b.addEventListener('click',()=>insertAtCursor(resp,ch)); kbd.appendChild(b); }); }
    mountKeyboard();
    resp.addEventListener('input',updateCount);
    closeDlg.addEventListener('click',()=>dlg.close());
    saveBtn.addEventListener('click',()=>{ if(!currentId) return; const cell=board.find(c=>c.id===currentId); cell.response=resp.value.slice(0,800); cell.completed=cell.free||cell.response.trim().length>=10||!!cell.audio; save(); render(); update(); dlg.close(); showToast('Enregistr√© ‚úÖ'); });
    clearCellBtn.addEventListener('click',()=>{ if(!currentId) return; const cell=board.find(c=>c.id===currentId); cell.response=''; if(!cell.free && !cell.audio) cell.completed=false; save(); render(); update(); resp.value=''; updateCount(); showToast('R√©ponse effac√©e'); });

    // ---------- Audio (record/upload/playback) ----------
    const recBtn=document.getElementById('recBtn'), stopBtn=document.getElementById('stopBtn'), playBtn=document.getElementById('playBtn'), delAudioBtn=document.getElementById('delAudioBtn'), uploadBtn=document.getElementById('uploadBtn'), uploadInput=document.getElementById('uploadInput'), audioEl=document.getElementById('audio'), timerEl=document.getElementById('timer'), permWarn=document.getElementById('permWarn');
    let mediaStream=null, mediaRec=null, chunks=[], t0=0, tick=null;
    function hhmm(s){const m=Math.floor(s/60),ss=('0'+(s%60)).slice(-2); return ('0'+m).slice(-2)+':'+ss;}
    async function preflightMic(){ try{ if(!('mediaDevices' in navigator)||!('MediaRecorder' in window)){ recBtn.disabled=stopBtn.disabled=playBtn.disabled=delAudioBtn.disabled=true; permWarn.style.display='block'; permWarn.textContent='Enregistrement audio non support√©.'; return; } if(navigator.permissions&&navigator.permissions.query){ try{ const st=await navigator.permissions.query({name:'microphone'}); if(st.state==='denied'){ permWarn.style.display='block'; permWarn.textContent='Micro refus√©. Autorise le micro.'; } }catch(e){} } }catch(e){} }
    async function startRec(){ try{ mediaStream=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRec=new MediaRecorder(mediaStream); chunks=[]; mediaRec.ondataavailable=e=>{ if(e.data&&e.data.size>0) chunks.push(e.data); }; mediaRec.onstop=()=>{ const blob=new Blob(chunks,{type:mediaRec.mimeType||'audio/webm'}); const reader=new FileReader(); reader.onloadend=()=>{ const cell=board.find(c=>c.id===currentId); cell.audio={dataUrl:reader.result,mime:blob.type||'audio/webm'}; cell.completed=true; save(); render(); update(); audioEl.src=reader.result; audioEl.style.display='block'; playBtn.disabled=false; delAudioBtn.disabled=false; showToast('Audio enregistr√© üéôÔ∏è'); }; reader.readAsDataURL(blob); cleanupStream(); }; mediaRec.start(); recBtn.disabled=true; stopBtn.disabled=false; playBtn.disabled=true; delAudioBtn.disabled=true; t0=Date.now(); timerEl.textContent='00:00'; tick=setInterval(()=>{ const s=Math.floor((Date.now()-t0)/1000); timerEl.textContent=hhmm(s); },250); }catch(err){ console.error(err); permWarn.style.display='block'; permWarn.textContent='Micro non accessible. Autorise le micro ou utilise ¬´¬†Importer audio¬†¬ª.'; showToast('Micro non accessible'); cleanupStream(); } }
    function stopRec(){ try{ if(mediaRec&&mediaRec.state!=='inactive') mediaRec.stop(); }catch(e){} stopBtn.disabled=true; recBtn.disabled=false; clearInterval(tick); tick=null; }
    function cleanupStream(){ try{ mediaStream&&mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){} mediaStream=null; mediaRec=null; clearInterval(tick); tick=null; timerEl.textContent='00:00'; }
    function loadAudioUI(cell){ if(cell&&cell.audio){ audioEl.src=cell.audio.dataUrl; audioEl.style.display='block'; playBtn.disabled=false; delAudioBtn.disabled=false; } else { audioEl.removeAttribute('src'); audioEl.style.display='none'; playBtn.disabled=true; delAudioBtn.disabled=true; } stopBtn.disabled=true; recBtn.disabled=false; timerEl.textContent='00:00'; }
    uploadBtn.addEventListener('click',()=>uploadInput.click());
    uploadInput.addEventListener('change',()=>{ const f=uploadInput.files&&uploadInput.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ const cell=board.find(c=>c.id===currentId); cell.audio={dataUrl:reader.result,mime:f.type||'audio/*'}; cell.completed=true; save(); render(); update(); audioEl.src=reader.result; audioEl.style.display='block'; playBtn.disabled=false; delAudioBtn.disabled=false; showToast('Audio import√© üì§'); }; reader.readAsDataURL(f); uploadInput.value=''; });
    recBtn.addEventListener('click',()=>startRec()); stopBtn.addEventListener('click',()=>stopRec()); playBtn.addEventListener('click',()=>audioEl.play()); delAudioBtn.addEventListener('click',()=>{ const cell=board.find(c=>c.id===currentId); delete cell.audio; if(!cell.free && !(cell.response&&cell.response.trim().length>=10)) cell.completed=false; save(); render(); update(); audioEl.removeAttribute('src'); audioEl.style.display='none'; playBtn.disabled=true; delAudioBtn.disabled=true; showToast('Audio supprim√©'); });

    // ---------- TTS sentence builder ----------
    const subSel=document.getElementById('sb-subj');
    const verbSel=document.getElementById('sb-verb');
    const compSel=document.getElementById('sb-comp');
    const impSel=document.getElementById('sb-impact');
    const connSel=document.getElementById('sb-conn');
    const suiteInp=document.getElementById('sb-suite');
    const outEl=document.getElementById('sb-out');
    const copyBtn=document.getElementById('sb-copy');
    const insertBtn=document.getElementById('sb-insert');
    const speakBtn=document.getElementById('sb-speak');
    const voiceSel=document.getElementById('sb-voice');
    const rateInp=document.getElementById('sb-rate');
    const ttsWarn=document.getElementById('ttsWarn');

    function buildSentence(){
      const subj=subSel.value; let verb=verbSel.value; const comp=compSel.value; const imp=impSel.value; const conn=connSel.value; const suite=suiteInp.value.trim();
      // Simple agreement for Je/Nous with common verbs (best effort)
      if(subj==='Je' && verb.endsWith('ons')) verb=verb.replace(/ons$/,'e');
      if((subj==='Nous' || subj==='Les √©l√®ves' || subj==='La communaut√©') && /e$/.test(verb)) verb = verb + 'nt'; // naive plural tweak for display only
      const sentence=`${subj} ${verb} ${comp} ${imp}. ${conn} ${suite||'‚Ä¶'}`.replace(/\s+/g,' ').trim();
      outEl.textContent=sentence; return sentence;
    }
    function mountBuilder(){ ['change','input'].forEach(ev=>{ [subSel,verbSel,compSel,impSel,connSel,suiteInp].forEach(el=>el.addEventListener(ev,buildSentence)); }); buildSentence(); }
    mountBuilder();

    copyBtn.addEventListener('click',()=>{ const s=buildSentence(); navigator.clipboard?.writeText?.(s).then(()=>showToast('Phrase copi√©e üìã')).catch(()=>showToast('Copie non autoris√©e')); });
    insertBtn.addEventListener('click',()=>{ const s=buildSentence(); if(!dlg.open){ showToast('Ouvre une case pour ins√©rer la phrase'); return; } insertAtCursor(resp,(resp.value&&!resp.value.endsWith('\n')?'\n':'')+s+' '); });

    // TTS
    function populateVoices(){ if(!('speechSynthesis' in window)) return; const voices=window.speechSynthesis.getVoices(); voiceSel.innerHTML=''; const frVoices=voices.filter(v=>/fr|French/i.test(v.lang)); (frVoices.length?frVoices:voices).forEach((v,i)=>{ const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; voiceSel.appendChild(opt); }); }
    function speak(text){ if(!('speechSynthesis' in window)) { ttsWarn.style.display='block'; return; } const u=new SpeechSynthesisUtterance(text); const voices=window.speechSynthesis.getVoices(); const v=voices.find(v=>v.name===voiceSel.value) || voices.find(v=>/fr|French/i.test(v.lang)) || voices[0]; if(v) u.voice=v; u.rate=parseFloat(rateInp.value||'1'); u.lang=(v&&v.lang)||'fr-FR'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }
    if('speechSynthesis' in window){ populateVoices(); window.speechSynthesis.onvoiceschanged=populateVoices; } else { ttsWarn.style.display='block'; }
    speakBtn.addEventListener('click',()=>speak(buildSentence()));

    // ---------- Tabs ----------
    document.querySelectorAll('.tabBtn').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tabContent').forEach(c=>c.classList.remove('active'));
      btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active');
    }));
  </script>
</body>
</html>
